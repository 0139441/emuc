<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Emulatrix | Leonardo Russo</title>
		<link rel="stylesheet" href="Emulatrix.css">
	</head>
	<body>
		<div id="container"><canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas></div>
		<script>
			function loadRomIntoVD()
				{
				// CREATES THE ROM FILE IN THE VIRTUAL DRIVE
				var dataView=new Uint8Array(parent.ROMDATA);
				FS.createDataFile("/","game.d64",dataView,true,false);
				}

			var Module =
				{
				preRun: [loadRomIntoVD],
				arguments: ["+truedrive"].concat(["-virtualdev"]).concat(["+VICIIdsize"]).concat(["-VICIIvcache"]).concat(["-soundfragsize","2"]).concat(["-soundrate","22050"]).concat(["-soundsync","0"]).concat(["-autostart", "game.d64"]),
				canvas: document.getElementById("canvas"),
				};

			var joystickEnabled = true;

			/*

			JOYSTICK KEY				VALUE

			FIRE						0x10
			EAST						0x08
			WEST						0x04
			SOUTH						0x02
			NORTH						0x01
			SOUTHWEST					0x02 | 0x04
			SOUTHEAST					0x02 | 0x08
			NORTHWEST					0x01 | 0x04
			NORTHEAST					0x01 | 0x08

			---------------------------------------

			KEYBOARD KEY				VALUE

			LEFT ARROW					96
			1							49
			2							50
			3							51
			4							52
			5							53
			6							54
			7							55
			8							56
			9							57
			0							48
			PLUS						189
			MINUS						187
			POUND						45
			CLR HOME					36
			INST DEL					8
			CTRL						9
			Q							113
			W							119
			E							101
			R							114
			T							116
			Y							121
			U							117
			I							105
			O							111
			P							112
			@							219
			*							221
			UP ARROW					127
			RUN STOP					27
			SHIFT LOCK					20
			A							97
			S							115
			D							100
			F							102
			G							103
			H							104
			J							106
			K							107
			L							108
			:							186
			;							222
			=							220
			RETURN						13
			CBM							1248
			LEFT SHIFT					1249
			Z							122
			X							120
			C							99
			V							118
			B							98
			N							110
			M							109
			,							44
			.							46
			/							47
			RIGHT SHIFT					1249
			CRSR UP						1106
			CRSR LEFT					1104
			CRSR RIGHT					1103
			CRSR DOWN					1105
			SPACE						32
			F1							1082
			F2							1083
			F3							1084
			F4							1085
			F5							1086
			F6							1087
			F7							1088
			F8							1089

			-----------------------------------------------
			EXAMPLE CODE FOR SENDING KEYS FROM THE KEYBOARD
			-----------------------------------------------

			var C64_SPACE_KEY_CODE = 32;

			function sendSpaceKeyPressedCode()
				{
				Module.ccall("keyboard_key_pressed", "undefined", ["number"], [C64_SPACE_KEY_CODE]);
				}

			function sendSpaceKeyReleasedCode()
				{
				Module.ccall("keyboard_key_released", "undefined", ["number"], [C64_SPACE_KEY_CODE]);
				}

			*/

			document.addEventListener("keydown", function(event)
				{
				if (joystickEnabled == true)
					{
					if (event.keyCode === 38) // UP
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x01]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 40) // DOWN
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x02]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 37) // LEFT
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x04]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 39) // RIGHT
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x08]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 17) // CTRL
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x10]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					}
				}, false);

			document.addEventListener("keyup", function(event)
				{
				if (joystickEnabled == true)
					{
					if (event.keyCode === 38) // UP
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x01]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 40) // DOWN
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x02]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 37) // LEFT
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x04]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 39) // RIGHT
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x08]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 17) // CTRL
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x10]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					}
				}, false);

			window.onload = function()
				{
				document.getElementById("container").style.display="block";
				}

			window.onerror = function (msg, url, lineNo, columnNo, error)
				{
				alert(parent.valueErrorWhileLoading + msg.toUpperCase());
				parent.document.location.href = "Emulatrix.htm";
				return true;
				}
		</script>
		<script src="Emulatrix_Commodore64.js"></script>
	</body>
</html>