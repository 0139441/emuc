<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Emulatrix | Leonardo Russo</title>
		<link rel="stylesheet" href="Emulatrix.css">
	</head>
	<body>
		<div id="container"><canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas></div>
		<script>
			function loadRomIntoVD()
				{
				// CREATES THE ROM FILE IN THE VIRTUAL DRIVE
				var dataView=new Uint8Array(parent.ROMDATA);
				FS.createDataFile("/","game.d64",dataView,true,false);
				}

			var Module =
				{
				preRun: [loadRomIntoVD],
				arguments: ["+truedrive"].concat(["-virtualdev"]).concat(["+VICIIdsize"]).concat(["-VICIIvcache"]).concat(["-soundfragsize","2"]).concat(["-soundrate","22050"]).concat(["-soundsync","0"]).concat(["-autostart", "game.d64"]),
				canvas: document.getElementById("canvas"),
				};

			var joystickEnabled = true;

			/*
			JOYSTICK KEY				VALUE

			FIRE						0x10
			EAST						0x08
			WEST						0x04
			SOUTH						0x02
			NORTH						0x01
			SOUTHWEST					0x02 | 0x04
			SOUTHEAST					0x02 | 0x08
			NORTHWEST					0x01 | 0x04
			NORTHEAST					0x01 | 0x08

			*/

			document.addEventListener("keydown", function(event)
				{
				if (joystickEnabled == true)
					{
					if (event.keyCode === 38) // UP
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x01]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 40) // DOWN
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x02]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 37) // LEFT
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x04]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 39) // RIGHT
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x08]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 17) // CTRL
						{
						Module.ccall("joystick_set_value_or", "undefined", ["number", "number"],[2,0x10]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					}
				}, false);

			document.addEventListener("keyup", function(event)
				{
				if (joystickEnabled == true)
					{
					if (event.keyCode === 38) // UP
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x01]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 40) // DOWN
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x02]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 37) // LEFT
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x04]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 39) // RIGHT
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x08]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					else if (event.keyCode === 17) // CTRL
						{
						Module.ccall("joystick_set_value_and", "undefined", ["number", "number"],[2,~0x10]);
						event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();return false;
						}
					}
				}, false);

			window.onload = function()
				{
				document.getElementById("container").style.display="block";
				}

			window.onerror = function (msg, url, lineNo, columnNo, error)
				{
				alert(parent.valueErrorWhileLoading + msg.toUpperCase());
				parent.document.location.href = "Emulatrix.htm";
				return true;
				}
		</script>
		<script src="Emulatrix_Commodore64.js"></script>
	</body>
</html>